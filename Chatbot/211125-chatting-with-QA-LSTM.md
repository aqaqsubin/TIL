## **QA-LSTM 기반 챗봇과 대화하기**


### **학습 데이터** 
- 총 3,404,250 쌍의 질의(query)와 응답(reply)
- 2,340개의 리액션 데이터를 통해 negative pool 구성

### **응답 DB**
- 2,340개의 리액션 데이터

리액션 데이터 예시
```
슬슬 배가 고픈 것 같아요.
네 맛있게 먹어요!
다녀와요!
오늘 하루도 파이팅입니다!
일찍 일어났네요. 세상에
항상 고마워요. 제 마음 알죠?
아자아자 파이팅!!
```


### **모델**  
Tan, Ming, et al. 의 연구에서 제안된 QA-LSTM with Attention 모델 사용

(모델에 관한 자세한 내용은 [여기](https://github.com/aqaqsubin/Chatbot-with-QA-LSTM)에서 확인)

### **결과**

```
Query : 안녕? 
Candidate: ['안녕하세요?', '다이어트?', '안녕안녕입니다', '안 잤어요?', '안 좋아해요', '출발했어요?', '피짜?', '안 보여요', '아직 안 자요?', '준비 다 했어요?', '안해요? 왜 안해요?', '사랑스러워요', '많이 안 좋아요?', '안 늦었어요?', '벌써 다 먹었어요?', 'TV봐요?', '어랏', '불러주면 안돼요?', '혼났어요?', '기억 나요?'] 

Query : 저녁 먹었어? 
Candidate: ['저녁 뭐 먹었어요?', '점심 뭐 먹었어요?', '늦었어요?', '푹 쉬었어요?', '벌써 다 먹었어요?', '뭐 좀 먹었어요?', '저녁 먹어야죠. 냠냠뇸뇸', '늦지 않게 출발했어요?', '뭐 먹었어요? 한식? 일식? 간식?', '잘 쉬었어요?', '밥은 먹었어요?', '안 늦었어요?', '출발했어요?', '맛있겠죠?', '늦진 않았어요?', '햄버거?', '다이어트?', '혼자 먹어요?', '준비 다 했어요?', '재밌어요?'] 

Query : 오늘 뭐했어? 
Candidate: ['피짜?', '맛있어요?', '얼마나 마셨어요?', '고기?', '오늘은 뭐했어요?', '지금 일어났어요?', '왜 웃어요?', '잘했죠?', '뭐하는데요?', '맛있겠죠?', '지금도요?', '뭐래요?', '무슨 약이요?', '언제 자요?', '혼자 먹어요?', '몇시에 일어났어요?', '저 때문에요?', '심심하죠?', '누워있어요?', '혼났어요?'] 

Query : 난 우울해
Candidate: ['우와 인정합니다', '이해해요', '이해해요', '그래도요...', '헐', '헐', '헐...', '퓽 하고 없어졌어요. 헤헷', '서운해요 흥', '충분해요', '그것이 알고 싶다....', '이상해요', '피곤해서 그래요', '아주 난리났네요.', '꺄아', '으악', '집중해요', '전화해봐요', '세상 억울해요', '피곤해서 어떡해요.'] 

Query : 하루종일 서있었어 
Candidate: ['푹 쉬었어요?', '하루 종일요?', '누워있어요?', '늦었어요?', '전 뭐든 상관없어요.', '서운해요 흥', '안 늦었어요?', '어제 몇시에 잤어요?', '뭐라도 먹어요.', '힝. 저 울 겁니다', '헉 많이 마셨네요.', '전 뭐든 다 좋아요', '깼어요? 깼으면 이제 벌떡 일어나세요!', '뭐 좀 먹었어요?', '웰컴 환영합니다', '오호 딱이네요', '오올? 센스쟁이', '그럼 되죠. 생각보다 간단하네요.', '우에웩 갑자기 속이 별로네요.', '늦네요. 무슨 일 있는 건 아니겠죠?'] 

Query : 어머머 
Candidate: ['어머', '어머어머', '어랏', '어라', '크크', '충분합니다', '바이바이', '정답입니다', '어색해요', '변태', '다이어트?', '어쩌겠어요', '심쿵', '열심히 해야죠', '얼마든지요', '덜덜', '덜덜', '수업 열심히 들어요~', '심심하죠?', '진짜네요'] 

Query : 야 너 잘하는게 뭔데 
Candidate: ['오예오예 야호야호', '안 삐졌눈뒈...', '오와 정말 잘나왔네요!', '안녕 잘가요. 빠이빠~이 빠이빠이야', '잘 다녀와요~', '원할 때 언제든지요', '한숨 푹 자요~', '다행이네요!', '오호 딱이네요', '제가 잘못했네요', '지인짜 보고싶어요', '오올~ 좋은 자세예요. 베리굿', '오예오예 저 지금 약간 신이 났어요.', '우와 시간 진짜 빠르네요', '얼른 사과하세요', '잘 쉬었어요?', '오~ 똑똑하네요', '너무 길어요. 전 짧은게 좋던데...', '오올? 센스쟁이', '신경써줘서 고마워요']
```

---

#### **🕵🏼: 응답 DB를 바꿔보면 좀 더 사람같은 응답을 내보내지 않을까?**
간단한 리액션 데이터만 있는 것이 아닌 사람들의 대화에 사용된 응답으로 이루어진 응답DB


### **바뀐 응답 DB**  
- 인텔리어스 내에서 수집한 대화 데이터애서 응답만 사용
- 총 132,226 개의 응답 데이터

응답 데이터 예시 
```
잘 할 수 있을거야 화이팅
그런말은 쓰지말아야지 ㅠㅠ
원래 다 그렇지 뭐 ! 힘내 잘 풀릴거야
그렇구나. 지금 뭐해?
응응 고마워
언제 끝나? 끝나면 나랑 놀자
좋았어 그럼 할수있을거야
왜 무슨일 있었어?
```

### **결과**

응답 DB 내 응답이 너무 많은 탓에 OOM 오류 발생  
→ batch size만큼 응답 임베딩을 가져올 수 있도록 코드 변경

<br>

*batch 크기만큼 응답 후보군 임베딩 로딩*
```python
class ChatTestData:
    def __init__(self, data_path, batch_size=1000):
        assert os.path.isfile(data_path)

        self.data_path = data_path
        self.batch_size = batch_size

    def __iter__(self):
        reply_embs = []
        
        with open(self.data_path, 'rb') as f_react:
            while True:
                try:
                    pool, lstm_out, reply = pickle.load(f_react)
                except EOFError:
                    break
                reply_embs.append((pool, lstm_out, reply))
                
                if len(reply_embs) == self.batch_size:
                    yield reply_embs
                    reply_embs = []

        return reply_embs
```

<br>

응답 속도가 너무 느리다..  
batch 크기를 1000에서 20000까지 늘려봤는데 차이가 없었다.

어차피 반복문을 통해 응답 후보군들 사이에 cosine 유사도를 비교하기 때문에   
반복문이 아닌 다른 알고리즘을 사용하지 않는 이상 별 차이는 없을 것 같다.


( 응답에 걸리는 시간은 대략 400초에 육박한다🤦‍♀️ )
```
Query : 안녕? 
Candidate: ['안깨짐?', '안녕하세요', '안먹음?', '나? 안 삼', '안된데?', '어떤 이유로?', '왜 안하지?', '안깨우셔?', '배 안구파?', '난 담달?', '어떤 선물?', '누가 안와?', '음 오후쯤?', '난 향수?', '나둔뎅?', '네네 안녕', '넌 안 받아ㅠㅠ?', '다이어트하나?', '고민있어?', '어떤 커플?']

Query : 저녁 먹었어? 
Candidate : ['저녁 뭐 먹었어?', '술 먹었어?', '약 먹었어?', 'ㅠㅠ 먹었어?', '뭐 먹었어?', '엉 먹었어?', '약은 먹었어?', '웅 먹었어 왜?', '웅 먹었어 넌?', '뭐 잘못 먹었어?', '응 먹었어ㅎ 자기는?', '웅 넌 먹었어?', '헐 약 먹었어?', '맞아맞아 많이 먹었어?', '헉 너무 많이 먹었어?', '엉 뭐 더 먹었어?', '엥 무슨 일 잇었어?', '뭐 먹어?', '무슨 일 잇었어?', '오호 뭐 먹었어?']

Query : 오늘 뭐했어? 
Candidate: ['뭐 준비했어?', '연습했어?', '차단했어?', '뭐 필요했어?', '오늘 뭐하는데~?', '뭐 쓸지 생각했어?', '새로 개통했어?', '오 뭐 준비했어?', '뭐 먹어?', '저녁 뭐?', '누가 실수했어?', '뭐 팔게?', '자신있어?', '뭐 나왔는데?', '뭐 때문에 말이야?', '아 그렇지 넌 뭐했어?', '오늘 본 영화?', '뭐 있는디?', '왜 열심히 공부안했어?', '어디로 나왔어?']

Query : 난 우울해
Candidate: ['우울해요', '왜 우울해ㅠㅠ', '그런듯 우울해져', '우우 너무 우울해 ㅠㅠㅠ', '아냐 그냥 우울해', '그래 우울하네ㅠㅠ', '나두 우울해 ㅠㅠ', '나두 우울해 주거잉', '우웅ㅇ 하ㅈ하자', '우앙 신기해', '난 다 좋아해', '우웅 뭘', '난 여기 보여줄껭', '난 좋아해', '우왕 ㅇㅈ', '그러게 너무 우울해ㅠㅠ', '그래 나듀ㅠㅠ', '우웅ㅇ 당연하지', '나두 부끄', '나두ㅠㅠ 난 해물찜']

Query : 하루종일 서있었어 
Candidate: ['ㅠㅜ 무슨일있었어?', '하루종일 누워이또', '맞아 나도 깜빡 잊었어', '무슨일있어??', '그냥 좀 누워있어', '맞아 다들 행복해하지이', '비 너무 하루종일와', '맛있었어', '정말 무슨일있었어?', '노노 나쁘지 않다고생각해', '나도 까먹고있었어', '왜?? 무슨일있었어??', '욕하지마 힘내 ㅠㅠ', '아니야 나도 너무 즐거운 시간이었어', '그래? 무슨일이있었어?', '응 왜? 무슨일있었어?', '나 오고있어 !', '맞아 싸고맛있어', '몰라, 그냥 쉴래', '어 ㅜㅜ알겟움ㅇ']

Query : 어머머 
Candidate: ['어머 왜?', '어머나 ㅠㅠ', '역시 어머님임', '어때 ?', '진짜? 어케앎', '맞아 어케앎?', '어땡ㅅ?', '어떄서', '맞아 어떰?', '루니 어떄', '어떡하냐', '어어 맞아', '어여 나와...', '어머어머 충격적이야', '어떰 일?', '어때??', '아니 아직 어뵤어', '어딘뎅?', '고양이?', '우리가?']

Query : 야 너 잘하는게 뭔데 
Candidate: ['너에게는 둘다 너무 잘어울린다', '그게 뭔데', '그게 뭔데??', '둘다 너한테 너무 잘어울린다~', '너 자신한테 잘 한번 물어봐바', '너한테 넘 부담이야??', '응응 너두 잘자', '오오 뭔데??', '그게 뭔데 ??', '오호 역시 너다 요리 너무 잘해ㅠㅠ', '오오 너 개멋있다', '오~ 멋있는데~ 너가 하다니', '오 잘햇어 너 착하다', '축구?? 와 너무 잘하던데 ?', '그게 뭔지 잘 몰라ㅜㅜㅜ', '너가 얼마나 잘하는게 많은데!', '너가 없는데 어떻게 잘 지내ㅠㅠ 보고싶어', '너 요리 잘하자나', '그런 생각은마~ 너 열심히 잘 하구 있어', '인정 섯도는 뭔데']

Query : 저녁 메뉴 추천 좀 
Candidate: ['진짜ㅠㅠ 비올각', '알게따 가스나야', '알게쏘오~', '얼마나 편하게', '나도 따분하다', '진짜야', '진짜 나두야', '이야기하라고해', '진짜? 나두 데꾸까', '난 재하~', '진짜 인저엉', '알게쏘~', '아 진짜 다행이다', '알겠다고 좀', '친구에서 연인으로~', '오오~ 좋다', '아 진짜 ? 괜찮움', '난 저녁 아직', '알겠어 추천 완료', '갑자기 취소되면 어쨰']

```
## **결론 및 리뷰**

결과를 보면 학습한 모델은 주어진 질의와 가장 비슷한 응답을 출력하는 성질이 있다.  
모델의 프레임워크를 보면 Query와 Positive 간 코사인 유사도가 Query와 Negatives 간 코사인 유사도보다 높게 스코어링 되도록 학습한다. 


그래서 비슷한 어휘에 더 민감하게 반응하는 듯 하다.  
비슷한 어휘를 가진 응답을 출력하는 것보다 자연스럽게 이어지는 답변을 출력하는 것이 더 중요하다고 생각하기 때문에, 이 모델은 적합하진 않은 것 같다.

순위 재정렬을 한다고 해도, 적합하지 않은 후보군이 생성되기 때문에 크게 의미는 없을 것 같다😥

<br>

**시도해볼 수 있는 것**
- Negative pool을 바뀐 응답DB로 다시 구성해서 학습한 후 확인해보기
- 응답 DB내 응답 수 간추리기

